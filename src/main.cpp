#include "controller/TAIFEXPacketParser.h"
#include "storage/TAIFEXMemoryDatabase.h"
#include <fstream>
#include <vector>
#include <iostream>

int main() {
    // ================================================
    // 1ï¸âƒ£ è¼‰å…¥å°åŒ…æª”æ¡ˆï¼ˆè«‹å°‡æ¸¬è©¦æª”æ”¾åœ¨ ./data ç›®éŒ„ä¸‹ï¼‰
    // ================================================
    std::ifstream file("../data/Opt.bin", std::ios::binary); // ğŸ“ å¯ä¿®æ”¹æª”æ¡ˆåç¨±
    if (!file) {
        std::cerr << "âŒ ç„¡æ³•é–‹å•Ÿå°åŒ…æª”æ¡ˆï¼è«‹ç¢ºèªè·¯å¾‘èˆ‡æª”åæ˜¯å¦æ­£ç¢ºã€‚\n";
        return 1;
    }

    // è®€å–æª”æ¡ˆè‡³ bufferï¼ˆä»¥äºŒé€²ä½æ¨¡å¼è®€å–å®Œæ•´æª”æ¡ˆå…§å®¹ï¼‰
    std::vector<uint8_t> buffer(std::istreambuf_iterator<char>(file), {});
    std::cout << "âœ… å°åŒ…æª”æ¡ˆè®€å–å®Œæˆï¼Œå¤§å°ï¼š" << buffer.size() << " bytes\n";

    // ================================================
    // 2ï¸âƒ£ åˆå§‹åŒ–å°åŒ…è§£æå™¨ä¸¦åŸ·è¡Œè§£ææµç¨‹
    // ================================================
    TAIFEXPacketParser parser(buffer);
    parser.parseAll();

    // ================================================
    // 3ï¸âƒ£ å»ºç«‹è¨˜æ†¶é«”è³‡æ–™åº«ï¼Œå­˜å…¥æ‰€æœ‰è§£æçµæœ
    // ================================================
    TAIFEXMemoryDatabase db;
    for (const auto& result : parser.getResults()) {
        db.add(result);
    }

    // ================================================
    // 4ï¸âƒ£ è¼¸å‡ºè§£æå¾Œçš„å°åŒ…è³‡è¨Šï¼ˆfor Debug/é©—è­‰ç”¨ï¼‰
    // ================================================
    db.dump();

    std::cout << "âœ… å°åŒ…è§£æèˆ‡è³‡æ–™å„²å­˜æµç¨‹çµæŸã€‚\n";
    std::cout << "=========================================\n";

    return 0;
}
