# TAIFEX 封包解析系統設計文件

版本：v0.1  
作者：sbc  
更新日期：2025-05-21

---

## ✅ 1. 功能項目（功能模組清單）

### 📦 PacketDecoder 封包解碼模組

- **用途**：根據封包 HEADER 中的 Message ID，選擇對應的解析器並解析 BODY 成結構化資料物件（如 FormatI020 → `I020ParsedResult`）。
- **設計動機**：解耦主流程與解析細節，支援多格式擴充與測試，減少重複程式碼。
- ✅ 合理設計：對應 `TWSEParserFactory` 工廠產出適當的 `TWSEFormatParser` 實例。
- 🔧 **關鍵功能**：
  - 自動識別 `formatCode`
  - 呼叫對應 `parser->parse()`
  - 傳回共用型別 `shared_ptr<TWSEParsedResult>`

---

### 💾 DataStorage 資料儲存模組

- **用途**：將解析出的資料依照商品代碼儲存在記憶體容器（如 `std::map`）或 SQLite 資料庫中。
- **設計動機**：支援後續查詢與展示、避免重複解析、能快取即時狀態。
- ✅ 合理設計：封裝儲存邏輯，支援雙模式（記憶體／資料庫）。
- 🔧 **關鍵功能**：
  - 儲存 Format6 成交明細與統計資料
  - 依商品代碼查詢歷史紀錄
  - 匯出成 CSV／JSON

---

### 🔁 StateUpdater 狀態更新模組

- **用途**：根據即時封包更新商品的即時狀態，如最新價格、漲跌幅、五檔報價。
- **設計動機**：集中更新邏輯，避免資料不一致。
- ✅ 合理設計：支援 I020, I021, I080, I012 等格式資料整合。
- 🔧 **關鍵功能**：
  - 更新「最高/最低價」
  - 維護五檔委託簿
  - 計算當前漲跌幅與漲跌停價階數

---

### 🔍 DataQuery 資料查詢與顯示模組

- **用途**：提供查詢介面供 UI 或匯出模組使用，包括商品資訊、分時資料、成交明細等。
- **設計動機**：集中資料讀取責任，提升模組可測試性與可維護性。
- ✅ 合理設計：所有查詢走同一介面，可統一錯誤處理與日誌記錄。
- 🔧 **關鍵功能**：
  - `getDealsByTime(productId, timeRange)`
  - `getMinuteBars(productId, interval)`
  - `getBasicInfo(productId)`

---

### 🖨️ OutputFormatter 輸出格式轉換模組

- **用途**：將資料轉換成 JSON、CSV 或 GUI 可視化格式，供外部系統或使用者檢視。
- **設計動機**：將資料表示與邏輯處理分離，支援多種前端／報表格式。
- ✅ 合理設計：輸出模組獨立於儲存與解碼模組，可重複利用。
- 🔧 **關鍵功能**：
  - 匯出 CSV（含 UTF-8 BOM）
  - JSON 轉換器
  - 整合 Qt 顯示結構（如 `QTableModel`）

---

## ✅ 2. 資料表欄位設計（In-memory struct 定義）

### 🔹 I010 商品基本資料（ProductInfo）
```cpp
struct ProductInfo {
    FixedString<10> prodId;
    BCD5 referencePrice;
    char prodKind;
    BCD1 decimalLocator;
    BCD1 strikePriceDecimalLocator;
    BCD4 beginDate;
    BCD4 endDate;
    BCD1 flowGroup;
    BCD4 deliveryDate;
    char dynamicBanding; // 'Y' or 'N'
};
```

### 🔹 I012 商品漲跌幅資訊（PriceBandInfo）
```cpp
struct PriceLevel {
    BCD2 level;
    BCD5 price;
};

struct PriceBandInfo {
    FixedString<10> prodId;
    BCD1 noRaiseLimitLevels;
    std::vector<PriceLevel> raiseLimitList;
    BCD1 noFallLimitLevels;
    std::vector<PriceLevel> fallLimitList;
};
```

### 🔹 I020 成交價量資訊（MatchInfo）
```cpp
struct PriceQtyPair {
    char sign;
    BCD5 price;
    BCD2 quantity;
};

struct MatchInfo {
    FixedString<20> prodId;
    BCD6 matchTime;
    char firstSign;
    BCD5 firstPrice;
    BCD4 firstQty;
    uint8_t matchDisplayItem;
    std::vector<PriceQtyPair> matchList;
    BCD4 totalQty;
    BCD4 buyCount;
    BCD4 sellCount;
    BCD1 statusCode;
};
```

### 🔹 I080 委託簿資訊（OrderBookInfo）
```cpp
struct OrderBookLevel {
    char bidSign;
    BCD5 bidPrice;
    BCD4 bidQty;
    char askSign;
    BCD5 askPrice;
    BCD4 askQty;
};

struct OrderBookInfo {
    FixedString<20> prodId;
    uint8_t revealFlag;
    std::vector<OrderBookLevel> levels;
};
```

---

## ✅ 3. 資料處理流程圖（PlantUML）
![資料處理流程圖](/mnt/data/資料處理流程圖.png)



## ✅ 4. 系統物件圖（PlantUML）
![模組物件圖](/mnt/data/系統物件圖.png)



---

## ✅ 5. 圖形視覺化


